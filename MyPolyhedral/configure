#!/usr/bin/perl -w
use strict;
use warnings;

#
# This is the perlscript of "MyPolyhedral" only.
# Other perlscript are generated by other perl scripts.
#



my $SysFile="sysinfo.gap";

open(INFILE, $SysFile) or die "cannot found ".$SysFile;
my @BU=<INFILE>;
close(INFILE);

my $iLineSearch=0;
while(1)
{
    my $eLineT = $BU[$iLineSearch];
    my @LChar=split("", $eLineT);
    my @ST=split("AParch", $eLineT);
    if (scalar(@ST) eq 2 && $LChar[0] ne "#")
    {
	last;
    }
    $iLineSearch += 1;
}
chomp($BU[$iLineSearch]);

my @HS=split("=", $BU[$iLineSearch]);

my $arch=$HS[1];
if ($HS[0] ne "GAParch")
{
    my $siz=scalar(@HS);
    print "siz=".$siz."\n";
    print "iLineSearch=".$iLineSearch."\n";
    print "Inconsistency in the code\n";
    print "Failed to find the path\n";
    die "Please correct\n";
}


#########################

my $order1="rm -rf bin/*";
print $order1."\n";
if (system($order1) != 0) {
    die "Error in rm -rf bin";
}

my $order2="mkdir bin/".$arch;
print $order2."\n";
if (system($order2) != 0) {
    die "Error in mkdir";
}

my @U=();
$U[0]="x86_64-unknown-linux-gnu-gcc";
$U[1]="x86_64-unknown-linux-gnu-gcc-default64";
$U[2]="x86_64-pc-linux-gnu-gcc-default64";
$U[3]="i386-unknown-freebsd5.1-gcc";
$U[4]="i686-pc-linux-gnu-gcc";
$U[5]="x86_64-pc-linux-gnu-default64-kv7";
#@U = (); # We disable that functionality
my $nbU=scalar(@U);
for (my $iU=1; $iU<=$nbU; $iU++)
{
    my $ArchB=$U[$iU-1];
    if ($arch ne $ArchB)
    {
	my $order3="ln -sf ./".$arch." bin/".$ArchB;
	print $order3."\n";
        if (system($order3) != 0) {
            die "Error in ln -sf";
        }
    }
}

my $eListProg="/tmp/ListProg";

my $order4="ls listlink/ > ".$eListProg;
print $order4."\n";
if (system($order4) != 0) {
    die "Error in ls listlink";
}

open(INF, $eListProg) or die "impossible to open ".$eListProg;
while(<INF>)
{
    chomp($_);
    my $order5="(cd bin/".$arch." && ln -s ../../listlink/".$_." .)";
    print $order5."\n";
    if (system($order5) != 0) {
        die "Error in ln -sf";
    }
}
close(INF);

my $order6="rm -f ".$eListProg;
print $order6."\n";
if (system($order6) != 0) {
    die "Error in rm -rf";
}
